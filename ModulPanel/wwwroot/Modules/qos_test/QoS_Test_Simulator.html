<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>QoS Simülatörü v0.18 (Multi‑Flow Policy)</title>
<style>
  :root{--blue:#1d8cf8;--orange:#fb8c00;--red:#e53935;--green:#2e7d32;--bg:#f5f7fb;--panel:#fff;--muted:#6b7280;--ink:#0f172a;--shadow:0 2px 10px rgba(16,24,40,.08)}
  *{box-sizing:border-box}
  body{margin:0;padding:20px;background:var(--bg);font:14px/1.4 Inter,system-ui,Arial,Helvetica,sans-serif;color:var(--ink);display:flex;gap:20px}
  h3{margin:6px 0 12px}
  .panel{background:var(--panel);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  .sidebar{width:410px}
  .main{flex:1;min-width:520px}
  .btn{width:100%;padding:10px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
  .btn.blue{background:var(--blue);color:#fff}
  .btn.orange{background:var(--orange);color:#fff}
  .btn.gray{background:#eef2f7;color:#334155}
  .btn.red{background:var(--red);color:#fff}
  .row{display:flex;gap:8px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  label{display:block;font-size:12px;color:#374151;margin-bottom:4px}
  input,select{width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px}
  .hr{height:1px;background:#e5e7eb;margin:12px 0}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .pill{padding:10px;border-radius:10px;background:#eef2f7;display:flex;justify-content:space-between;gap:8px}
  .pill .meta{font-size:12px}
  .mini{padding:6px 8px;border:none;border-radius:6px;cursor:pointer}
  .mini.gray{background:#e5e7eb}
  .mini.red{background:#fecaca}
  .badge{font-size:11px;padding:2px 6px;border-radius:6px;background:#e2f0ff;color:#0369a1;margin-left:6px}
  .badge.default{background:#dcfce7;color:#166534}
  .muted{color:var(--muted);font-size:12px}
  .output{white-space:pre-wrap;height:720px;overflow:auto;background:#0b1220;border-radius:12px;border:1px solid #0b1220;padding:14px;color:#e6e6e6;font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
  .output .h{color:#93c5fd}.output .k{color:#fbbf24}.output .ok{color:#34d399}.output .no{color:#fca5a5}.output .advice{color:#fcd34d}
  .calcbox{background:#f8fafc;border:1px solid #e2e8f0;border-radius:10px;padding:10px}
  .calcgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .calcrow{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px}
  .highlight{background:#fff59d;color:#111;padding:2px 6px;border-radius:6px;font-weight:700}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:50}
  .modal{width:1024px;max-height:90vh;overflow:auto;background:#fff;border-radius:12px;box-shadow:var(--shadow);padding:18px}
  .section{border:1px dashed #e5e7eb;border-radius:12px;padding:12px;margin:8px 0}
  .multi{border:1px solid #d1d5db;border-radius:8px;padding:8px;max-height:140px;overflow:auto;background:#fafafa}
  .flowcard{border:1px solid #e5e7eb;border-radius:10px;padding:10px;margin:8px 0;background:#fcfcfd}
  .flowhdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .tag{display:inline-block;padding:1px 6px;border-radius:999px;font-size:11px;background:#e5e7eb;margin-left:6px}
</style>
</head>
<body>
  <div class="panel sidebar">
    <h3>Interface (Global)</h3>
    <div class="grid">
      <div>
        <label>Interface Bandwidth (Mbps)</label>
        <input id="if_bw" type="number" value="100"/>
      </div>
      <div class="calcbox">
        <div class="row" style="justify-content:space-between"><label style="margin:0">Efektif BW (Shaper)</label></div>
        <div class="calcgrid">
          <div><label>Overhead (B)</label><input id="oh_over" type="number" value="80"></div>
          <div><label>Payload (B)</label><input id="oh_pay" type="number" value="1500"></div>
        </div>
        <div class="calcrow"><span class="muted">Oran = Overhead/Payload</span><span id="oh_ratio" class="muted">≈ 0.053</span></div>
        <div class="calcrow"><span class="muted">Shaper = IF_BW / (1 + Oran)</span><span id="oh_shaper" class="highlight">≈ 95.0 Mbps</span></div>
      </div>
    </div>
    <div class="muted" style="margin-top:6px">Örnek: IF_BW=30 Mbps, Overhead/Payload=80/1500 → <b>≈ 28.5 Mbps</b>.</div>

    <div class="hr"></div>
    <h3>Default Class</h3>
    <div id="defaultSummary" class="muted">Henüz işaretlenmedi.</div>
    <div class="hr"></div>

    <h3>Class Listesi</h3>
    <button id="btn_new_class" class="btn blue" type="button">+ Yeni Class Ekle</button>
    <div id="classList" class="list"></div>
    <div class="hr"></div>

    <h3>Hazır Test Policy</h3>
    <div class="row">
      <button id="btn_p_voip" class="btn gray" type="button">VoIP Trafik</button>
      <button id="btn_p_video" class="btn gray" type="button">Video + Ses</button>
      <button id="btn_p_mixed" class="btn gray" type="button">Karışık Trafik</button>
    </div>
    <div class="muted" style="margin-top:6px">Not: Hazır policy'ler <b>multi‑flow</b> policy olarak eklenir.</div>
    <div class="hr"></div>

    <h3>Özel Test Policy</h3>
    <button id="btn_new_test" class="btn blue" type="button">+ Test Policy (Multi‑Flow)</button>
    <div id="testList" class="list"></div>
    <div class="hr"></div>

    <button id="btn_run" class="btn orange" type="button">Simülasyonu Başlat</button>
  </div>

  <div class="panel main">
    <h3>Simülasyon Sonuçları</h3>
    <div id="output" class="output">Henüz başlatılmadı.</div>
  </div>

  <!-- Class Modal (same as v0.17) -->
  <div id="classBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <h3>Class Tanımı</h3>
        <button id="btn_cls_close" class="btn gray" style="width:auto" type="button">Kapat</button>
      </div>

      <div class="grid">
        <div><label>Class Adı *</label><input id="cls_name" placeholder="Örn: VOIP" required/></div>
        <div><label>—</label><input disabled value="Interface BW üst panelden alınır"/></div>
      </div>

      <div class="section">
        <h4>QoS Parametreleri <span class="badge">Zorunlu: CIR, Ceiling, Priority, Queue‑Type</span> <span class="badge default">İstersen Default</span></h4>
        <div class="grid3">
          <div><label>Bandwidth % (CIR) *</label><input id="cls_cir" type="number" min="0" max="100"></div>
          <div><label>Ceiling % *</label><input id="cls_ceil" type="number" min="0" max="100"></div>
          <div><label>Priority (1–7) *</label>
            <select id="cls_prio"><option>1</option><option>2</option><option selected>3</option><option>4</option><option>5</option><option>6</option><option>7</option></select>
          </div>
        </div>
        <div class="grid">
          <div><label>Queue‑Type *</label>
            <select id="cls_queue"><option>fq-codel</option><option>fair-queue</option><option>drop-tail</option><option>priority</option><option>random-detect</option></select>
          </div>
          <div class="row"><input id="cls_is_default" type="checkbox" style="width:auto"><label for="cls_is_default" style="margin:0">Bu class default olsun</label></div>
        </div>
        <div class="grid">
          <div><label>Burst (bytes)</label><input id="cls_burst" type="number"></div>
          <div><label>Interval (ms)</label><input id="cls_interval" type="number"></div>
          <div><label>Queue‑limit (pkt)</label><input id="cls_qlimit" type="number"></div>
          <div><label>Quantum</label><input id="cls_quantum" type="number"></div>
          <div><label>Target Delay (ms)</label><input id="cls_tdelay" type="number"></div>
          <div><label>DSCP (0‑63)</label><input id="cls_dscp" type="number"></div>
        </div>
      </div>

      <div class="section">
        <h4>Filtre Parametreleri</h4>
        <div class="grid">
          <div><label>Source Network (CIDR; ; ile çoklu)</label><input id="cls_srcnet" placeholder="10.0.0.0/24;10.0.1.0/24"></div>
          <div><label>Destination Network (CIDR; ; ile çoklu)</label><input id="cls_dstnet" placeholder="192.168.1.0/24;192.168.2.0/24"></div>
          <div><label>Source Port</label><input id="cls_sport" placeholder="5060"></div>
          <div><label>Destination Port</label><input id="cls_dport" placeholder="5060"></div>
        </div>
        <div class="hr"></div>
        <div class="row" style="gap:16px;align-items:flex-start">
          <div style="flex:1">
            <div class="row" style="justify-content:space-between;"><label>Application (çoklu)</label><input id="cls_app_import" type="file" accept=".json" style="width:auto"></div>
            <div class="row"><input id="cls_app_search" placeholder="Uygulama ara..."><span class="muted">JSON: application[].name</span></div>
            <div id="cls_app_multi" class="multi"></div>
          </div>
          <div style="flex:1">
            <div class="row" style="justify-content:space-between;"><label>Category (çoklu)</label><span class="muted">Kaynak: main_tag.text</span></div>
            <div class="row"><input id="cls_cat_search" placeholder="Kategori ara..."></div>
            <div id="cls_cat_multi" class="multi"></div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:8px;gap:8px">
        <button id="btn_cls_save" class="btn blue" style="width:auto">Kaydet</button>
        <button id="btn_cls_cancel" class="btn gray" style="width:auto">Vazgeç</button>
      </div>
    </div>
  </div>

  <!-- Test Policy Modal (MULTI‑FLOW) -->
  <div id="testBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <h3>Test Policy (Multi‑Flow)</h3>
        <button id="btn_test_close" class="btn gray" style="width:auto">Kapat</button>
      </div>

      <div class="grid">
        <div><label>Policy Adı *</label><input id="tp_name" placeholder="Örn: Ofis‑Gündüz Politikası"></div>
        <div class="row" style="justify-content:flex-end;gap:8px">
          <button id="btn_add_flow" class="btn blue" style="width:auto">+ Akış Ekle</button>
          <button id="btn_add_random" class="btn gray" style="width:auto">+ Rastgele Akış</button>
        </div>
      </div>

      <div id="flowsContainer"></div>

      <div class="row" style="margin-top:8px;gap:8px">
        <button id="btn_test_save" class="btn blue" style="width:auto">Kaydet</button>
        <button id="btn_test_cancel" class="btn gray" style="width:auto">Vazgeç</button>
      </div>
    </div>
  </div>

<script>
  // ====== Global State ======
  let classDB=[], testDB=[];
  let defaultClassName=null;
  let importedApps=[], importedCats=[];
  // current class modal selections
  let clsAppSel=new Set(), clsCatSel=new Set();
  // test modal temp flows
  let tmpFlows=[];

  // ====== Error Handler ======
  window.addEventListener('error', e=>{
    const out=document.getElementById('output');
    if(out){ out.innerHTML = 'Hata: '+e.message+'\\n'+(e.error&&e.error.stack?e.error.stack:''); }
  });

  // ====== DOM Ready ======
  window.addEventListener('DOMContentLoaded', ()=>{
    // Effective BW
    ['if_bw','oh_over','oh_pay'].forEach(id=>{
      const el=document.getElementById(id); ['input','change','keyup'].forEach(ev=> el.addEventListener(ev, recalcEffective));
    });
    recalcEffective();

    // Sidebar buttons
    id('btn_new_class').onclick = ()=> openClassModal();
    id('btn_new_test').onclick  = ()=> openTestModal();
    id('btn_p_voip').onclick    = ()=> presetPolicy('voip');
    id('btn_p_video').onclick   = ()=> presetPolicy('video');
    id('btn_p_mixed').onclick   = ()=> presetPolicy('mixed');
    id('btn_run').onclick       = ()=> runSimulation();

    // Class modal
    id('btn_cls_close').onclick = closeClassModal;
    id('btn_cls_cancel').onclick= closeClassModal;
    id('btn_cls_save').onclick  = saveClass;
    id('cls_app_import').addEventListener('change', handleImport);
    id('cls_app_search').addEventListener('input', ()=> filterList('#cls_app_multi','#cls_app_search'));
    id('cls_cat_search').addEventListener('input', ()=> filterList('#cls_cat_multi','#cls_cat_search'));
    id('cls_is_default').addEventListener('change', e=> toggleDefaultName(e.target.checked));

    // Test modal
    id('btn_test_close').onclick= closeTestModal;
    id('btn_test_cancel').onclick= closeTestModal;
    id('btn_test_save').onclick = saveTestPolicy;
    id('btn_add_flow').onclick   = ()=> { addFlow(); renderFlows(); };
    id('btn_add_random').onclick = ()=> { addFlow(randomFlow()); renderFlows(); };

    renderClassList();
    renderTestList();
  });

  // ====== Helpers ======
  const id = s=>document.getElementById(s);
  function recalcEffective(){
    const ifbw=+id('if_bw').value||0, ovh=+id('oh_over').value||0, pay=Math.max(1,+id('oh_pay').value||1500);
    const ratio=ovh/pay, eff=ifbw/(1+ratio);
    id('oh_ratio').textContent = '≈ '+(Math.round(ratio*1000)/1000);
    id('oh_shaper').textContent = '≈ '+(Math.round(eff*10)/10)+' Mbps';
  }
  function filterList(containerSel, inputSel){
    const q=(document.querySelector(inputSel).value||'').toLowerCase();
    document.querySelectorAll(containerSel+' label').forEach(l=>{
      l.parentElement.style.display = l.textContent.toLowerCase().includes(q) ? 'block':'none';
    });
  }
  function log(msg){
    const out=id('output'); out.innerHTML = '['+new Date().toLocaleTimeString()+'] '+msg+'\\n'+out.innerHTML;
  }
  function round2(x){ return Math.round((x+Number.EPSILON)*100)/100; }
  function isNum(v){ return v!==null && v!==undefined && v!=='' && !isNaN(+v); }
  function splitCIDRs(text){ return (text||'').split(';').map(s=>s.trim()).filter(Boolean); }

  // ====== Class Modal ======
  function openClassModal(){
    id('classBackdrop').style.display='flex';
    ['cls_name','cls_cir','cls_ceil','cls_burst','cls_interval','cls_qlimit','cls_quantum','cls_tdelay','cls_dscp','cls_srcnet','cls_dstnet','cls_sport','cls_dport']
      .forEach(x=> id(x).value='');
    id('cls_queue').value='fq-codel'; id('cls_prio').value='3';
    id('cls_is_default').checked=false; toggleDefaultName(false);
    clsAppSel=new Set(); clsCatSel=new Set();
    renderMulti('#cls_app_multi',[],importedApps,'capp');
    renderMulti('#cls_cat_multi',[],importedCats,'ccat');
  }
  function closeClassModal(){ id('classBackdrop').style.display='none'; }
  function toggleDefaultName(checked){
    const nm=id('cls_name');
    if(checked){ nm.value='Default'; nm.disabled=true; }
    else { if(nm.value==='Default') nm.value=''; nm.disabled=false; }
  }
  document.addEventListener('change', e=>{
    const t=e.target;
    if(t.matches('#cls_app_multi input[type=checkbox]')){ t.checked?clsAppSel.add(t.value):clsAppSel.delete(t.value); }
    if(t.matches('#cls_cat_multi input[type=checkbox]')){ t.checked?clsCatSel.add(t.value):clsCatSel.delete(t.value); }
    if(t.matches('[data-flow][data-kind="app"]')){
      const idx=+t.getAttribute('data-flow');
      t.checked? tmpFlows[idx].apps.add(t.value) : tmpFlows[idx].apps.delete(t.value);
    }
    if(t.matches('[data-flow][data-kind="cat"]')){
      const idx=+t.getAttribute('data-flow');
      t.checked? tmpFlows[idx].cats.add(t.value) : tmpFlows[idx].cats.delete(t.value);
    }
  });
  function saveClass(){
    const name = (id('cls_name').value||'').trim();
    const cir=+id('cls_cir').value, ceil=+id('cls_ceil').value, prio=+id('cls_prio').value;
    if(!name && !id('cls_is_default').checked){ alert('Class adı zorunlu'); return; }
    const finalName = id('cls_is_default').checked ? 'Default' : name;
    if(!isNum(cir)||!isNum(ceil)|| !(prio>=1&&prio<=7)){ alert('CIR/Ceil/Öncelik zorunlu'); return; }
    const obj={
      name:finalName, queue:id('cls_queue').value, priority:prio, cir, ceil,
      burst: numVal('cls_burst'), interval:numVal('cls_interval'), qlimit:numVal('cls_qlimit'),
      quantum:numVal('cls_quantum'), tdelay:numVal('cls_tdelay'), dscp:numVal('cls_dscp'),
      srcnets:splitCIDRs(id('cls_srcnet').value), dstnets:splitCIDRs(id('cls_dstnet').value),
      sport:id('cls_sport').value.trim(), dport:id('cls_dport').value.trim(),
      apps:Array.from(clsAppSel), categories:Array.from(clsCatSel)
    };
    classDB.push(obj);
    if(id('cls_is_default').checked) defaultClassName='Default';
    closeClassModal(); renderClassList(); log('Class kaydedildi: '+finalName);
  }
  function numVal(x){ const v=id(x).value; return v===''?null:+v; }

  function handleImport(evt){
    const file=evt.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload= e=>{
      try{
        const data=JSON.parse(e.target.result);
        importedApps=(data.application||[]).map(a=>a.name).filter(Boolean).sort((a,b)=>a.localeCompare(b));
        importedCats=Array.from(new Set((data.application||[]).map(a=>(a.main_tag&&a.main_tag.text)||'Unknown'))).sort((a,b)=>a.localeCompare(b));
        renderMulti('#cls_app_multi',[],importedApps,'capp');
        renderMulti('#cls_cat_multi',[],importedCats,'ccat');
        // also refresh any open flow cards
        renderFlows();
        log(`Application_Id içe aktarıldı: ${importedApps.length} uygulama, ${importedCats.length} kategori.`);
      }catch(err){ alert('JSON hatası: '+err.message); }
    };
    reader.readAsText(file);
  }
  function renderMulti(containerSel, selectedValues, allValues, key, flowIdx=null){
    const el=document.querySelector(containerSel); if(!el) return; el.innerHTML='';
    allValues.forEach(val=>{
      const idd=(key+'_'+val).replace(/\\s+/g,'_')+(flowIdx!==null?('_'+flowIdx):'');
      const wrap=document.createElement('div');
      const cb=document.createElement('input'); cb.type='checkbox'; cb.id=idd; cb.value=val;
      if(selectedValues.includes(val)) cb.checked=true;
      cb.setAttribute('data-flow', flowIdx!==null?flowIdx:'');
      cb.setAttribute('data-kind', key.includes('app')?'app':'cat');
      const lab=document.createElement('label'); lab.htmlFor=idd; lab.textContent=' '+val;
      wrap.appendChild(cb); wrap.appendChild(lab); el.appendChild(wrap);
    });
  }

  // ====== List Renders ======
  function renderClassList(){
    const list=id('classList'); list.innerHTML='';
    classDB.forEach(c=>{
      const pill=document.createElement('div'); pill.className='pill';
      pill.innerHTML=`<div class="meta"><strong>${c.name}</strong> ${c.name==='Default'?'<span class="badge default">default</span>':''}<br>
        prio ${c.priority} · CIR ${c.cir}% / Ceil ${c.ceil}% · ${c.queue}<br>srcCIDR:${c.srcnets?.length||0} / dstCIDR:${c.dstnets?.length||0}</div>
        <div><button class="mini red">Sil</button></div>`;
      pill.querySelector('.mini.red').onclick=()=>{ if(c.name==='Default') defaultClassName=null; classDB=classDB.filter(x=>x!==c); renderClassList(); };
      list.appendChild(pill);
    });
    id('defaultSummary').textContent = defaultClassName?('Seçilen: '+defaultClassName):'Henüz işaretlenmedi.';
  }
  function renderTestList(){
    const list=id('testList'); list.innerHTML='';
    testDB.forEach((p,i)=>{
      const total=p.flows.reduce((s,f)=>s+(+f.rate||0),0);
      const pill=document.createElement('div'); pill.className='pill';
      pill.innerHTML=`<div class="meta"><strong>${p.name}</strong> <span class="tag">${p.flows.length} akış</span><br>
        toplam ≈ ${round2(total)} Mbps</div>
        <div><button class="mini red">Sil</button></div>`;
      pill.querySelector('.mini.red').onclick=()=>{ testDB.splice(i,1); renderTestList(); };
      list.appendChild(pill);
    });
  }

  // ====== Test Modal (Multi‑Flow) ======
  function openTestModal(){
    id('testBackdrop').style.display='flex';
    id('tp_name').value='';
    tmpFlows=[]; // start empty
    // add one blank by default
    addFlow();
    renderFlows();
  }
  function closeTestModal(){ id('testBackdrop').style.display='none'; }

  function addFlow(obj){
    const f = obj || {name:'Akış '+(tmpFlows.length+1), rate:10, pkt:1200, dscp:0, proto:'any',
                      srcip:'', dstip:'', sport:'', dport:'', apps:new Set(), cats:new Set()};
    tmpFlows.push(f);
  }
  function randomIP(base){ // base like 10.0.0.
    return base + (Math.floor(Math.random()*200)+10);
  }
  function randomFlow(){
    const dscps=[0,8,10,34,46], protos=['tcp','udp','any'];
    return {name:'Rnd '+(tmpFlows.length+1), rate: Math.floor(Math.random()*15)+5, pkt:1200, dscp: dscps[Math.floor(Math.random()*dscps.length)], proto: protos[Math.floor(Math.random()*protos.length)],
            srcip: randomIP('10.0.0.'), dstip: randomIP('192.168.1.'), sport: String(Math.floor(Math.random()*50000)+1000), dport: String(Math.floor(Math.random()*50000)+1000),
            apps:new Set(), cats:new Set()};
  }

  function renderFlows(){
    const cont=id('flowsContainer'); cont.innerHTML='';
    tmpFlows.forEach((f,idx)=>{
      const card=document.createElement('div'); card.className='flowcard';
      card.innerHTML=`
        <div class="flowhdr"><div><strong>${f.name}</strong> <span class="tag">${f.proto.toUpperCase()}</span></div>
          <div class="row"><button class="mini gray" data-act="apps">Uyg/Kat</button><button class="mini red" data-act="del">Sil</button></div>
        </div>
        <div class="grid3">
          <div><label>Akış Adı</label><input data-f="${idx}" data-field="name" value="${f.name}"></div>
          <div><label>Hız (Mbps)</label><input type="number" data-f="${idx}" data-field="rate" value="${f.rate}"></div>
          <div><label>Paket Boyutu (B)</label><input type="number" data-f="${idx}" data-field="pkt" value="${f.pkt}"></div>
        </div>
        <div class="grid3" style="margin-top:6px">
          <div><label>DSCP</label><input type="number" data-f="${idx}" data-field="dscp" value="${f.dscp}"></div>
          <div><label>Protokol</label>
            <select data-f="${idx}" data-field="proto">
              <option ${f.proto==='any'?'selected':''}>any</option>
              <option ${f.proto==='tcp'?'selected':''}>tcp</option>
              <option ${f.proto==='udp'?'selected':''}>udp</option>
            </select>
          </div>
        </div>
        <div class="grid" style="margin-top:6px">
          <div><label>Source IP (tekil)</label><input data-f="${idx}" data-field="srcip" value="${f.srcip}"></div>
          <div><label>Destination IP (tekil)</label><input data-f="${idx}" data-field="dstip" value="${f.dstip}"></div>
          <div><label>Source Port</label><input data-f="${idx}" data-field="sport" value="${f.sport}"></div>
          <div><label>Destination Port</label><input data-f="${idx}" data-field="dport" value="${f.dport}"></div>
        </div>
        <div id="apps_${idx}" class="section" style="display:none">
          <h4>Application & Category (Akış ${idx+1})</h4>
          <div class="row" style="gap:16px;align-items:flex-start">
            <div style="flex:1">
              <div class="row" style="justify-content:space-between"><label>Application (çoklu)</label><span class="muted">Kaynak: import edilen liste</span></div>
              <div class="row"><input id="tp_app_search_${idx}" placeholder="Uygulama ara..."></div>
              <div id="tp_app_multi_${idx}" class="multi"></div>
            </div>
            <div style="flex:1">
              <div class="row" style="justify-content:space-between"><label>Category (çoklu)</label><span class="muted">Kaynak: import edilen liste</span></div>
              <div class="row"><input id="tp_cat_search_${idx}" placeholder="Kategori ara..."></div>
              <div id="tp_cat_multi_${idx}" class="multi"></div>
            </div>
          </div>
        </div>`;
      // attach handlers for buttons on this card
      card.querySelector('[data-act="del"]').onclick = ()=>{ tmpFlows.splice(idx,1); renderFlows(); };
      card.querySelector('[data-act="apps"]').onclick = ()=>{
        const sec=id('apps_'+idx);
        const show = sec.style.display==='none';
        // render lists into this section (per flow)
        renderMulti('#tp_app_multi_'+idx, Array.from(f.apps), importedApps, 'tpapp', idx);
        renderMulti('#tp_cat_multi_'+idx, Array.from(f.cats), importedCats, 'tpcat', idx);
        // wire up search
        const appSearch=id('tp_app_search_'+idx), catSearch=id('tp_cat_search_'+idx);
        if(appSearch) appSearch.oninput = ()=> filterList('#tp_app_multi_'+idx, '#tp_app_search_'+idx);
        if(catSearch) catSearch.oninput = ()=> filterList('#tp_cat_multi_'+idx, '#tp_cat_search_'+idx);
        sec.style.display = show?'block':'none';
      };
      // bind input updates
      card.querySelectorAll('input[data-f],select[data-f]').forEach(inp=>{
        inp.oninput = (ev)=>{
          const i=+ev.target.getAttribute('data-f'); const field=ev.target.getAttribute('data-field');
          tmpFlows[i][field] = (ev.target.type==='number'? +ev.target.value : ev.target.value);
        };
      });
      cont.appendChild(card);
    });
    if(tmpFlows.length===0){
      const hint=document.createElement('div'); hint.className='muted'; hint.textContent='Henüz akış yok. "Akış Ekle" ile ekleyin.'; cont.appendChild(hint);
    }
  }

  function saveTestPolicy(){
    const name=(id('tp_name').value||'').trim();
    if(!name){ alert('Policy adı zorunlu'); return; }
    // finalize sets -> arrays
    const flows = tmpFlows.map(f=>({...f, apps:Array.from(f.apps), cats:Array.from(f.cats)}));
    testDB.push({name, flows});
    closeTestModal(); renderTestList(); log('Policy eklendi: '+name+' ('+flows.length+' akış)');
  }

  // ====== Presets (multi‑flow) ======
  function presetPolicy(kind){
    let policy={name:'', flows:[]};
    if(kind==='voip'){
      policy.name='VoIP Policy';
      policy.flows=[{name:'VoIP-1',rate:8,pkt:160,dscp:46,proto:'udp',srcip:'10.0.0.10',dstip:'192.168.1.20',sport:'5060',dport:'5060',apps:['magicjack','skype'],cats:['Voice over IP']}];
    }else if(kind==='video'){
      policy.name='Video+Ses';
      policy.flows=[
        {name:'Video',rate:18,pkt:1200,dscp:34,proto:'udp',srcip:'10.0.0.20',dstip:'192.168.1.30',sport:'5004',dport:'5004',apps:['youtube'],cats:['Streaming']},
        {name:'Ses',  rate:4, pkt:160, dscp:46,proto:'udp',srcip:'10.0.0.22',dstip:'192.168.1.31',sport:'5060', dport:'5060', apps:['magicjack'],cats:['Voice over IP']},
      ];
    }else{
      policy.name='Karışık';
      policy.flows=[
        {name:'YouTube', rate:12,pkt:1200,dscp:34,proto:'tcp',srcip:'10.0.0.51',dstip:'192.168.1.51',sport:'443',dport:'443',apps:['youtube'],cats:['Streaming']},
        {name:'Facebook',rate:6,pkt:1200,dscp:0, proto:'tcp',srcip:'10.0.0.52',dstip:'192.168.1.52',sport:'443',dport:'443',apps:['facebook'],cats:['Social']},
        {name:'Bulk',    rate:30,pkt:1200,dscp:0, proto:'tcp',srcip:'10.0.0.53',dstip:'192.168.1.53',sport:'',dport:'',apps:['bittorrent'],cats:['File Sharing']},
      ];
    }
    testDB.push(policy); renderTestList(); log('Hazır policy eklendi: '+policy.name);
  }

  // ====== Simulation ======
  function expandFlows(){
    // flatten all policies to single flow array with backrefs
    const arr=[];
    testDB.forEach(p=> (p.flows||[]).forEach((f,i)=> arr.push({policy:p.name, idx:i, ...f})));
    return arr;
  }

  function runSimulation(){
    const outEl=id('output'); outEl.textContent='Simülasyon çalıştırılıyor...';
    if(classDB.length===0){ alert('En az bir class ekleyin'); outEl.textContent=''; return; }
    if(!defaultClassName){
      const has = classDB.find(c=>c.name==='Default'); if(has) defaultClassName='Default';
    }
    if(!defaultClassName){ alert('Bir default class işaretleyin (Class düzenle > "Bu class default olsun")'); outEl.textContent=''; return; }

    const iface = +id('if_bw').value||0;
    const flows = expandFlows();
    const flowResults = flows.map(f=> classifyFlow(f, classDB, defaultClassName));

    // offered per class
    const offered={}; classDB.forEach(c=> offered[c.name]=0);
    flowResults.forEach(fr=> offered[fr.matchedClass]+= (+fr.flow.rate||0) );

    const {alloc, steps} = allocateCapacityVerbose(classDB, offered, iface);

    // per class flows mapping
    const perClass={} ; flowResults.forEach(fr=>{ (perClass[fr.matchedClass] ||= []).push(fr); });

    // narratives
    const flowNarratives=[];
    for(const [clsName, fl] of Object.entries(perClass)){
      const off = fl.reduce((s,x)=>s+(+x.flow.rate||0),0);
      const ad  = alloc[clsName]?.admitted||0;
      const ratio = off>0 ? Math.min(1, ad/off) : 1;
      fl.forEach(fr=>{
        fr.accepted = round2((+fr.flow.rate||0)*ratio);
        fr.dropped  = round2(Math.max(0, (+fr.flow.rate||0) - fr.accepted));
        flowNarratives.push(explainFlow(fr, classDB, alloc[clsName], fl));
      });
    }

    // queue behaviour & advices
    const dq={}; classDB.forEach(c=>{
      const fl = perClass[c.name]||[]; dq[c.name] = queueStats(c, alloc[c.name], fl);
    });

    // ---- Output ----
    let out='';
    out += color('=== 1) QoS Template Özeti ===\\n','h');
    classDB.sort((a,b)=>a.priority-b.priority).forEach(c=>{
      const cirMbps  = round2(iface*(+c.cir||0)/100);
      const ceilMbps = round2(iface*(+c.ceil||0)/100);
      out += `• ${c.name}${c.name===defaultClassName?' [default]':''}  (prio ${c.priority})\\n`+
             `  - CIR ${c.cir}% ≈ ${cirMbps} Mbps  |  Ceil ${c.ceil}% ≈ ${ceilMbps} Mbps  |  Queue ${c.queue}\\n`+
             `  - Filtreler: srcCIDR ${(c.srcnets||[]).length} | dstCIDR ${(c.dstnets||[]).length} | sport ${c.sport||'-'} | dport ${c.dport||'-'} | DSCP ${isNum(c.dscp)?c.dscp:'-'} | apps ${c.apps?.length||0} | cats ${c.categories?.length||0}\\n`;
    });
    out += '\\n';

    out += color('=== 2) Test Policy Özeti ===\\n','h');
    if(testDB.length===0){ out += '• Tanımlı policy yok.\\n\\n'; }
    else{
      testDB.forEach(p=>{
        out += `• ${p.name} — ${p.flows.length} akış\\n`;
        p.flows.forEach(f=>{
          out += `   - ${f.name}: ${f.rate}Mbps, pkt ${f.pkt}B, DSCP ${f.dscp}, ${f.srcip||'-'}→${f.dstip||'-'} ${f.sport||'-'}:${f.dport||'-'} (apps:${(f.apps||[]).join(',')||'-'}; cats:${(f.cats||[]).join(',')||'-'})\\n`;
        });
      });
      out += '\\n';
    }

    out += color('=== 3) Akış → Class Kararı (adım adım) ===\\n','h');
    flowNarratives.forEach(n=> out += n+'\\n');

    out += color('=== 4) Kapasite Dağıtımı ===\\n','h');
    steps.forEach(s=> out += '• '+s+'\\n');
    out += '\\n';
    out += classDB.map(c=>{
      const A=alloc[c.name]; const off=offered[c.name]||0;
      return `→ ${c.name}: Offered ${round2(off)} Mbps  |  Admitted ${round2(A.admitted)} Mbps  |  Drop ${round2(Math.max(0,off-A.admitted))} Mbps`;
    }).join('\\n') + '\\n\\n';

    out += color('=== 5) Kuyruk Davranışı (tahmini) ===\\n','h');
    classDB.forEach(c=>{
      const q=dq[c.name];
      const extra=(c.queue==='drop-tail')?'drop-tail: queue-limit ve burst dolana kadar gecikme artar, sonra düşüş.':
                  (c.queue==='fq-codel')?'fq-codel: target/interval ile erken düşürme; gecikmeyi sabitlemeye çalışır.':
                  (c.queue==='random-detect')?'RED: ortalama kuyruk yüksekse olasılıklı erken düşürür.':
                  (c.queue==='priority')?'priority: yüksek öncelik doluysa alt sınıflar bekler.':'fair-queue: akışlar arasında adil paylaşım.';
      out += `• ${c.name}: delay≈${q.delayMs}ms, jitter≈${q.jitterMs}ms, ${q.dropStart>0?('drop başlangıcı ~'+q.dropStart+'s'):'drop beklenmiyor'}; CPU≈${q.cpu}% — ${extra}\\n`;
    });
    out += '\\n';

    out += color('=== 6) Öneriler ===\\n','h');
    out += buildAdvices(classDB, alloc, dq) || '• Kritik bir durum gözlenmedi.\\n';
    out += '\\n';

    out += color('=== 7) Senaryo Değerlendirme (özet) ===\\n','h');
    out += scenarioSummary(classDB, alloc, offered, iface);
    outEl.innerHTML = out;
  }

  // ====== Core QoS helpers (reused) ======
  function classifyFlow(flow, classes, defaultName){
    let matches=[];
    for(const c of classes){
      const r=matchAgainstClass(flow, c);
      if(r.ok) matches.push({c,score:r.score,reasons:r.reasons});
    }
    if(matches.length===0){
      return {flow, matchedClass: defaultName, reasons:['Hiçbir class filtresine uymadığı için default.'], specificity:0};
    }
    matches.sort((a,b)=> b.score - a.score || a.c.priority - b.c.priority);
    return {flow, matchedClass: matches[0].c.name, reasons: matches[0].reasons, specificity:matches[0].score};
  }
  function matchAgainstClass(flow,c){
    let ok=true, reasons=[], score=0;
    if(c.apps&&c.apps.length){ const inter=intersect(flow.apps||[], c.apps); if(inter.length){reasons.push('Application ✓ ('+inter.join(', ')+')'); score+=3;} else {ok=false; reasons.push('Application ✗');} }
    if(ok && c.categories&&c.categories.length){ const inter=intersect(flow.cats||[], c.categories); if(inter.length){reasons.push('Category ✓ ('+inter.join(', ')+')'); score+=2;} else {ok=false; reasons.push('Category ✗');} }
    if(ok && isNum(c.dscp)){ if(+flow.dscp===+c.dscp){reasons.push('DSCP ✓ ('+c.dscp+')'); score+=1;} else {ok=false; reasons.push('DSCP ✗ ('+flow.dscp+')');} }
    if(ok && c.sport){ if(String(flow.sport||'')===String(c.sport)){reasons.push('Source port ✓ ('+c.sport+')'); score+=1;} else {ok=false; reasons.push('Source port ✗ ('+c.sport+' bekleniyor)');} }
    if(ok && c.dport){ if(String(flow.dport||'')===String(c.dport)){reasons.push('Dest port ✓ ('+c.dport+')'); score+=1;} else {ok=false; reasons.push('Dest port ✗ ('+c.dport+' bekleniyor)');} }
    if(ok && c.srcnets && c.srcnets.length){ if(ipNetsHas(flow.srcip, c.srcnets)){reasons.push('Source IP ✓ ('+flow.srcip+')'); score+=2;} else {ok=false; reasons.push('Source CIDR ✗ ('+flow.srcip+')');} }
    if(ok && c.dstnets && c.dstnets.length){ if(ipNetsHas(flow.dstip, c.dstnets)){reasons.push('Dest IP ✓ ('+flow.dstip+')'); score+=2;} else {ok=false; reasons.push('Dest CIDR ✗ ('+flow.dstip+')');} }
    return {ok,reasons,score};
  }
  function intersect(a,b){ return (a||[]).filter(x=> (b||[]).includes(x)); }
  function allocateCapacityVerbose(classes, offered, iface){
    const res={}, steps=[], G={}, C={}; let sumG=0;
    classes.forEach(c=>{ G[c.name]=iface*(+c.cir||0)/100; C[c.name]=iface*(+c.ceil||0)/100; sumG+=G[c.name]; });
    if(sumG>iface){ const k=iface/sumG; classes.forEach(c=> G[c.name]*=k ); steps.push('Toplam CIR '+round2(sumG)+' Mbps > interface '+iface+' Mbps → k='+round2(k)+' ile ölçeklendi.'); }
    else steps.push('Toplam CIR '+round2(sumG)+' Mbps ≤ interface '+iface+' Mbps → ölçekleme yok.');
    let used=0;
    classes.forEach(c=>{ const base=Math.min(offered[c.name]||0,G[c.name]); res[c.name]={guarantee:G[c.name], ceil:C[c.name], base, admitted:base, extra:0, offered:offered[c.name]||0}; used+=base; });
    let left=Math.max(0, iface-used); steps.push('CIR tahsisi sonrası kullanılan '+round2(used)+' Mbps, kalan '+round2(left)+' Mbps.');
    const need={}, ordered=[...classes].sort((a,b)=>a.priority-b.priority);
    classes.forEach(c=>{ const off=offered[c.name]||0; const max=Math.min(off,C[c.name]); need[c.name]=Math.max(0, max-res[c.name].admitted); });
    while(left>0){
      let any=false;
      for(const c of ordered){
        const n=need[c.name];
        if(n>0){ const give=Math.min(n,left); res[c.name].admitted+=give; res[c.name].extra+=give; need[c.name]-=give; left-=give; any=true; steps.push('  • '+c.name+': +'+round2(give)+' Mbps; kalan '+round2(left)+' Mbps'); if(left<=0) break; }
      }
      if(!any) break;
    }
    Object.keys(res).forEach(k=> steps.push(k+': Offered '+round2(res[k].offered)+' | Admitted '+round2(res[k].admitted)+' | Ceil '+round2(res[k].ceil)));
    return {alloc:res, steps};
  }
  function queueStats(c, alloc, flows){
    const admitted=alloc?.admitted||0, offered=(flows||[]).reduce((s,f)=>s+(+f.flow.rate||0),0);
    const pktAvg=Math.max(64, Math.round(weightedPkt(flows))); const pps= offered*1e6/(8*pktAvg);
    const factors={'fq-codel':1.2,'fair-queue':1.1,'priority':1.0,'drop-tail':0.9,'random-detect':1.3}; const baseCpu=(pps/10000)*(factors[c.queue]||1.0);
    const cpu=Math.min(100, Math.max(0, Math.round(baseCpu))); const baseDelay=({'priority':0.3,'fq-codel':1.0,'fair-queue':1.5,'drop-tail':3.0,'random-detect':2.0}[c.queue]||1.5);
    let delay=baseDelay, jitter=round2(baseDelay/2), dropStart=0;
    if(offered>admitted && admitted>0){
      const excess=(offered-admitted); const bytesPerSecExcess=excess*1e6/8; const qlimit=isNum(c.qlimit)?+c.qlimit:100; const burst=isNum(c.burst)?+c.burst:0;
      const queueBytes=qlimit*pktAvg + burst; const tfill=queueBytes/bytesPerSecExcess;
      if(c.queue==='drop-tail'){ delay += Math.min(250, (queueBytes/(admitted*1e6/8))*1000); jitter=round2(delay/3); dropStart=round2(tfill); }
      else if(c.queue==='fq-codel'){ const target=isNum(c.tdelay)?+c.tdelay:5; const interval=isNum(c.interval)?+c.interval:100; delay=Math.max(target,baseDelay); jitter=round2(target/2); dropStart=round2(interval/1000); }
      else if(c.queue==='random-detect'){ delay+=5; jitter=3; dropStart=0.1; }
      else { delay+=1.0; jitter=0.6; dropStart=round2(tfill); }
    }
    return {delayMs:round2(delay), jitterMs:round2(jitter), dropStart, cpu};
  }
  function weightedPkt(flows){ let total=0,sum=0; (flows||[]).forEach(f=>{ const r=+f.flow.rate||0; total+=r; sum += r*(+f.flow.pkt||1200); }); return total>0? sum/total : 600; }
  function color(txt,cls){ return '<span class="'+cls+'">'+txt+'</span>'; }
  function fmtIp(x){ return x || '-'; }
  function ipToInt(ip){ const m=/^(\\d+)\\.(\\d+)\\.(\\d+)\\.(\\d+)$/.exec(ip||''); if(!m) return null; const p=m.slice(1).map(Number); if(p.some(x=>isNaN(x)||x<0||x>255)) return null; return ((p[0]<<24)>>>0)+(p[1]<<16)+(p[2]<<8)+p[3]; }
  function inCIDR(ip,cidr){ const [b,m]=(cidr||'').split('/'); const mask=Number(m); const ipi=ipToInt(ip), bi=ipToInt(b); if(ipi===null||bi===null||isNaN(mask)) return false; const mm=mask===0?0:(0xFFFFFFFF << (32-mask))>>>0; return (ipi & mm)===(bi & mm); }
  function ipNetsHas(ip,nets){ return (nets||[]).some(n=> inCIDR(ip,n)); }
  function explainFlow(fr, classes, allocForClass, flowsInClass){
    const f=fr.flow; const c=classes.find(x=>x.name===fr.matchedClass);
    const pieces=[`• [${fr.policy}] ${f.name} → '${fr.matchedClass}'`];
    pieces.push('  - Eşleşme gerekçeleri: '+fr.reasons.join('; '));
    const off=flowsInClass.reduce((s,x)=>s+(+x.flow.rate||0),0);
    const ad=allocForClass?.admitted||0;
    const ratio=off>0? Math.min(1, ad/off):1;
    pieces.push(`  - Class yükü ≈ ${round2(off)} Mbps, ayrılan ≈ ${round2(ad)} Mbps → akış oranı ~${round2(ratio*100)}%`);
    pieces.push(`  - Akış: ${f.rate||0} Mbps → kabul ≈ ${round2((+f.rate||0)*ratio)} Mbps, drop ≈ ${round2(Math.max(0,(+f.rate||0)-(+f.rate||0)*ratio))} Mbps`);
    return pieces.join('\\n');
  }
  function scenarioSummary(classes, alloc, offered, iface){
    const names=classes.map(c=>c.name); const total=names.reduce((s,n)=>s+(offered[n]||0),0);
    let s='• QoS Testi ;\\n  - '+names.length+' tane Class tanımlı.\\n';
    classes.forEach(c=>{ const cirMbps=round2(iface*((+c.cir)||0)/100); s+=`    • ${c.name} : %${c.cir}  ${cirMbps}Mbps\\n`; });
    s+=`\\n  - BW : ${iface}Mbps olarak ayarlandı.\\n\\n  Test Toplamı (class başına teklif edilen):\\n`;
    names.forEach(n=> s+=`    ${n.padEnd(10,' ')} = ${round2(offered[n]||0)} Mbps\\n`);
    s+=`\\n  Toplamda = ${round2(total)} Mbps\\n\\n  Sınıf bazında değerlendirme:\\n`;
    names.forEach(n=>{ const off=offered[n]||0; const A=alloc[n]||{admitted:0, guarantee:0, ceil:0}; const cir=A.guarantee, ceil=A.ceil; const drop=Math.max(0, off-A.admitted);
      const parts=[`offered=${round2(off)}Mbps`,`CIR≈${round2(cir)}Mbps${off>cir?' (taştı)':' (içinde)'}`,`Ceil≈${round2(ceil)}Mbps${off>ceil?' (taştı)':' (içinde)'}`];
      if(drop>0){ const why=(A.admitted>=ceil-1e-6)?'Ceil sınırı':'öncelik/kalan kapasite'; parts.push(`DROP≈${round2(drop)}Mbps (${why})`); } else if(off>cir && off<=ceil){ parts.push('CIR üstü talep, öncelik ile karşılandı (drop yok)'); } else { parts.push('drop yok'); }
      s+=`    - ${n}: ${parts.join('; ')}\\n`; });
    s+='\\n';
    return s;
  }
</script>
</body>
</html>
